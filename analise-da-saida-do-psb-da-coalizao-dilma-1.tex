\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{votes} \hlkwb{<-} \hlkwd{read.csv}\hlstd{(}\hlstr{"data/54.csv"}\hlstd{,} \hlkwc{header} \hlstd{=} \hlnum{TRUE}\hlstd{,} \hlkwc{check.names} \hlstd{=} \hlnum{FALSE}\hlstd{)}
\hlstd{votes_metadata} \hlkwb{<-} \hlkwd{read.csv}\hlstd{(}\hlstr{"data/54-votacoes.csv"}\hlstd{,} \hlkwc{header} \hlstd{=} \hlnum{TRUE}\hlstd{,} \hlkwc{check.names} \hlstd{=} \hlnum{FALSE}\hlstd{)}
\end{alltt}
\end{kframe}
\end{knitrout}

\chapter{A saída do PSB da coalizão em Dilma I}\label{cap:analise-saida-psb}

\section{Introdução}

O PSB esteve na base de apoio do governo do PT desde que o partido conquistou a
Presidência da República com Lula em 2003. Dez anos depois, em 2013, penúltimo
ano do primeiro governo de Dilma, o PSB anuncia a candidatura de Eduardo Campos
para a presidência, rompendo a aliança com o PT.

Para entender a repercussão dessa mudança na Câmara dos Deputados, analisaremos
as votações nominais ocorridas naquela legislatura (54\textordfeminine, que
durou de 2011 até 2015) seguindo a metodologia proposta por Keith Poole em
\emph{Spatial models of parliamentary voting} \cite{Poole2005}.
% Não estamos entendendo a repercussão da mudança na CD como um todo, mas sim
% só no comportamento de votação dos parlamentares.

\section{Metodologia}{\label{sec:analise-saida-psb:metodologia}

Para entender a influência da saída do PSB no comportamento de votação dos
parlamentares, precisamos de uma forma de comparar o comportamento deles antes
e depois dessa mudança. Este é um problema complicado, estudado por diversos
autores (CITATION NEEDED). Nesta análise seguimos a metodologia de
\cite{Poole2005}.

Considerando um parlamentar por vez, o substituímos por dois parlamentares
``virtuais'' na tabela de votações, um com os votos antes da mudança e outro
com os votos depois dela, e executamos o algoritmo W-NOMINATE nessa nova
tabela. Esse procedimento é repetido para cada parlamentar separadamente,
enquanto mantém todos os outros sem modificações. Ao final, teremos dois pontos
para cada parlamentar: um para antes e outro para depois da mudança. A
diferença entre esses pontos representa o nível da mudança de comportamento no
período de análise. 

Por exemplo, considere a tabela \ref{table:exemplo-mudanca-de-comportamento}
contendo 3 parlamentares e 4 votações. Para definir qual foi a mudança de
comportamento de Samara entre as votações 2 e 3, dividimos seus votos em dois
parlamentares ``virtuais'', Samara 1 e Samara 2 (ver tabela
\ref{table:exemplo-parlamentar-virtual}), e executamos o algoritmo W-NOMINATE.
Guardamos os resultados de Samara e repetimos os mesmos passos para Pedro e
depois Maria. Ao final, teremos dois pontos para cada parlamentar: um relativo
a sua posição antes, e outro depois da mudança (ver figura
\ref{fig:exemplo-mudanca-de-comportamento}). A distância desses dois pontos é
uma medida da intensidade da mudança do parlamentar.  Comparando as distâncias
de cada parlamentar, podemos determinar se a mudança é significante ou não.

% TODO: Falar sobre o parametric bootstrap
% TODO: Falar sobre os problemas em comparar esses valores.
% \begin{quote}
%   ``(...) all matrices have the same number of nonmissing entries, and they
%   differ only in the fact that each has a different senator divided into two
%   records. Consequently, I believe it's safe to capture the 72 distances with
%   each other, because the differences between the configurations will be
%   trivial.''\cite{Poole2005}
% \end{quote}

\begin{table}
  \begin{minipage}{\textwidth}
    \centering
    \begin{tabular}{ l l l l l }
      nome & votação1 & votação2 & votação3 & votação4 \\
      \hline
      Samara & Sim & Sim & Não & Não \\
      Pedro & Sim & Sim & Sim & Sim \\
      Maria & Não & Não & Não & Não \\
    \end{tabular}
    \caption{Dados originais de votação}
    \label{table:exemplo-mudanca-de-comportamento}
  \end{minipage}
  \begin{minipage}{\textwidth}
    \centering
    \begin{tabular}{ l l l l l }
      nome & votação1 & votação2 & votação3 & votação4 \\
      \hline
      Samara 1 & Sim & Sim & & \\
      Samara 2 & & & Não & Não \\
      Pedro & Sim & Sim & Sim & Sim \\
      Maria & Não & Não & Não & Não \\
    \end{tabular}
    \caption{Dados de votação com Romário dividido no meio}
    \label{table:exemplo-parlamentar-virtual}
  \end{minipage}
\end{table}

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{data} \hlkwb{=} \hlkwd{data.frame}\hlstd{(}
  \hlkwc{nome} \hlstd{=} \hlkwd{rep}\hlstd{(}\hlkwd{c}\hlstd{(}\hlstr{"Samara"}\hlstd{,} \hlstr{"Pedro"}\hlstd{,} \hlstr{"Maria"}\hlstd{)),}
  \hlkwc{valor} \hlstd{=} \hlkwd{c}\hlstd{(}\hlnum{1}\hlstd{,} \hlnum{0.8}\hlstd{,} \hlopt{-}\hlnum{0.8}\hlstd{,} \hlopt{-}\hlnum{1}\hlstd{,} \hlnum{1}\hlstd{,} \hlopt{-}\hlnum{1}\hlstd{),}
  \hlkwc{periodo} \hlstd{=} \hlkwd{rep}\hlstd{(}\hlkwd{c}\hlstd{(}\hlstr{"Antes"}\hlstd{,} \hlstr{"Depois"}\hlstd{),} \hlnum{3}\hlstd{)}
\hlstd{)}
\hlkwd{ggplot}\hlstd{(data,} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= valor,} \hlkwc{y} \hlstd{= nome,} \hlkwc{shape} \hlstd{= periodo))} \hlopt{+}
  \hlkwd{geom_point}\hlstd{()} \hlopt{+}
  \hlkwd{theme_bw}\hlstd{()} \hlopt{+}
  \hlkwd{theme}\hlstd{(}\hlkwc{legend.title} \hlstd{=} \hlkwd{element_blank}\hlstd{())} \hlopt{+}
  \hlkwd{labs}\hlstd{(}\hlkwc{x} \hlstd{=} \hlstr{""}\hlstd{,} \hlkwc{y} \hlstd{=} \hlstr{""}\hlstd{)}
\end{alltt}


{\ttfamily\noindent\bfseries\color{errorcolor}{\#\# Error in eval(expr, envir, enclos): could not find function "{}ggplot"{}}}\end{kframe}
\end{knitrout}

% Pseudocódigo
%
% \begin{enumerate}
%   \item Para cada parlamentar, faça:
%   \begin{enumerate}
%     \item Crie dois parlamentares ``virtuais'', um com os votos do parlamentar
%       antes da mudança, e o outro com os votos depois dela;
%     \item Execute o W-NOMINATE na matriz completa de votações com todos os
%       parlamentares e o parlamentar em análise substituído pelos parlamentares
%       ``virtuais'';
%     \item Guarde o resultado;
%   \end{enumerate}
%   \item Compara a mudança de cada parlamentar de interesse com todos os outros,
%     para descobrir se ela (a mudança) foi significativa.
% \end{enumerate}

\section{Extração dos dados}

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{num_votes} \hlkwb{<-} \hlkwd{sum}\hlstd{(}\hlopt{!}\hlkwd{is.na}\hlstd{(votes[,} \hlnum{5}\hlopt{:}\hlkwd{ncol}\hlstd{(votes)]))}
\hlstd{num_votacoes} \hlkwb{<-} \hlkwd{ncol}\hlstd{(votes)} \hlopt{-} \hlnum{4}
\end{alltt}
\end{kframe}
\end{knitrout}

Os dados das votações nominais foram extraídos a partir da API disponibilizada
no site da Câmara dos Deputados. Eles compreendem 131552 votos
proferidos por 644 parlamentares em 432
votações. A figura \ref{fig:votacoes-por-mes} mostra a distribuição das
votações no período e a figura \ref{fig:deputados-por-partido} mostra o número
de deputados federais por partido. Só consideramos votos \verb|Sim| ou
\verb|Não|.  

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{votes_by_month_count} \hlkwb{=} \hlkwd{table}\hlstd{(}\hlkwd{format}\hlstd{(}\hlkwd{as.POSIXct}\hlstd{(votes_metadata}\hlopt{$}\hlstd{data),} \hlstr{"%Y-%m-01"}\hlstd{))}
\hlstd{votes_by_month_count} \hlkwb{=} \hlkwd{data.frame}\hlstd{(}\hlkwc{date} \hlstd{=} \hlkwd{as.POSIXct}\hlstd{(}\hlkwd{names}\hlstd{(votes_by_month_count)),}
                                  \hlkwc{count} \hlstd{=} \hlkwd{as.vector}\hlstd{(votes_by_month_count))}
\hlkwd{ggplot}\hlstd{(votes_by_month_count,} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= date,} \hlkwc{y} \hlstd{= count))} \hlopt{+}
  \hlkwd{geom_bar}\hlstd{(}\hlkwc{stat} \hlstd{=} \hlstr{"identity"}\hlstd{)} \hlopt{+}
  \hlkwd{theme_bw}\hlstd{()} \hlopt{+}
  \hlkwd{labs}\hlstd{(}\hlkwc{x} \hlstd{=} \hlstr{""}\hlstd{,} \hlkwc{y} \hlstd{=} \hlstr{"Votações"}\hlstd{)}
\end{alltt}


{\ttfamily\noindent\bfseries\color{errorcolor}{\#\# Error in eval(expr, envir, enclos): could not find function "{}ggplot"{}}}\end{kframe}
\end{knitrout}

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{parties_count} \hlkwb{=} \hlkwd{table}\hlstd{(votes}\hlopt{$}\hlstd{party)}
\hlstd{parties_count} \hlkwb{=} \hlkwd{data.frame}\hlstd{(}\hlkwc{party} \hlstd{=} \hlkwd{factor}\hlstd{(}\hlkwd{names}\hlstd{(parties_count),} \hlkwc{levels} \hlstd{=} \hlkwd{names}\hlstd{(}\hlkwd{sort}\hlstd{(parties_count))),}
                           \hlkwc{count} \hlstd{=} \hlkwd{as.vector}\hlstd{(parties_count))}
\hlkwd{ggplot}\hlstd{(parties_count,} \hlkwd{aes}\hlstd{(}\hlkwc{x} \hlstd{= party,} \hlkwc{y} \hlstd{= count))} \hlopt{+}
  \hlkwd{geom_bar}\hlstd{(}\hlkwc{stat} \hlstd{=} \hlstr{"identity"}\hlstd{)} \hlopt{+}
  \hlkwd{coord_flip}\hlstd{()} \hlopt{+}
  \hlkwd{theme_bw}\hlstd{()} \hlopt{+}
  \hlkwd{labs}\hlstd{(}\hlkwc{x} \hlstd{=} \hlstr{""}\hlstd{,} \hlkwc{y} \hlstd{=} \hlstr{"Deputados Federais"}\hlstd{)}
\end{alltt}


{\ttfamily\noindent\bfseries\color{errorcolor}{\#\# Error in eval(expr, envir, enclos): could not find function "{}ggplot"{}}}\end{kframe}
\end{knitrout}

\section{Análise}

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{votacao_divisoria} \hlkwb{=} \hlstd{votes_metadata[}\hlkwd{which}\hlstd{(}\hlkwd{colnames}\hlstd{(votes)} \hlopt{==} \hlnum{368}\hlstd{),]}
\hlstd{num_votacoes_antes} \hlkwb{=} \hlkwd{which}\hlstd{(}\hlkwd{colnames}\hlstd{(votes)} \hlopt{==} \hlstd{votacao_divisoria}\hlopt{$}\hlstd{id)} \hlopt{-} \hlnum{4} \hlopt{-} \hlnum{1}
\hlstd{num_votacoes_depois} \hlkwb{=} \hlkwd{ncol}\hlstd{(votes)} \hlopt{-} \hlstd{num_votacoes_antes}

\hlkwd{library}\hlstd{(data.table)}
\hlkwd{library}\hlstd{(plyr)}

\hlstd{result} \hlkwb{<-} \hlkwd{readRDS}\hlstd{(}\hlstr{"~/Projetos/Mestrado/theRealPipeline/results/output.rds"}\hlstd{)}
\hlstd{changed_coalitions} \hlkwb{<-} \hlkwd{read.csv}\hlstd{(}\hlstr{"data/parties_and_coalitions_changes.csv"}\hlstd{,}
                               \hlkwc{header} \hlstd{=} \hlnum{TRUE}\hlstd{,}
                               \hlkwc{check.names} \hlstd{=} \hlnum{FALSE}\hlstd{)}
\hlstd{changed_coalitions}\hlopt{$}\hlstd{rollcall_date} \hlkwb{<-} \hlkwd{as.POSIXct}\hlstd{(changed_coalitions}\hlopt{$}\hlstd{rollcall_date)}

\hlstd{coords} \hlkwb{<-} \hlkwd{rbindlist}\hlstd{(}
  \hlkwd{lapply}\hlstd{(result,} \hlkwa{function} \hlstd{(}\hlkwc{res}\hlstd{) \{}
    \hlstd{output} \hlkwb{=} \hlstd{res}\hlopt{$}\hlstd{legislators[}\hlnum{1}\hlopt{:}\hlnum{2}\hlstd{,]}
    \hlstd{same_party_legislators} \hlkwb{=} \hlstd{res}\hlopt{$}\hlstd{legislators[res}\hlopt{$}\hlstd{legislators}\hlopt{$}\hlstd{id} \hlopt{!=} \hlstd{output[}\hlnum{1}\hlstd{,} \hlstr{"id"}\hlstd{]} \hlopt{&} \hlstd{res}\hlopt{$}\hlstd{legislators}\hlopt{$}\hlstd{party} \hlopt{==} \hlstd{output[}\hlnum{1}\hlstd{,} \hlstr{"party"}\hlstd{],]}
    \hlstd{output}\hlopt{$}\hlstd{party.median} \hlkwb{=} \hlkwd{median}\hlstd{(same_party_legislators}\hlopt{$}\hlstd{coord1D,} \hlkwc{na.rm} \hlstd{=} \hlnum{TRUE}\hlstd{)}
    \hlstd{output}\hlopt{$}\hlstd{party.mean} \hlkwb{=} \hlkwd{mean}\hlstd{(same_party_legislators}\hlopt{$}\hlstd{coord1D,} \hlkwc{na.rm} \hlstd{=} \hlnum{TRUE}\hlstd{)}
    \hlstd{output}\hlopt{$}\hlstd{party.sd} \hlkwb{=} \hlkwd{sd}\hlstd{(same_party_legislators}\hlopt{$}\hlstd{coord1D,} \hlkwc{na.rm} \hlstd{=} \hlnum{TRUE}\hlstd{)}
    \hlstd{output}\hlopt{$}\hlstd{party.count} \hlkwb{=} \hlkwd{nrow}\hlstd{(same_party_legislators)}
    \hlstd{output}
  \hlstd{\})}
\hlstd{)}
\hlstd{clean_coords} \hlkwb{=} \hlkwd{ddply}\hlstd{(coords,} \hlkwd{.}\hlstd{(id),} \hlkwa{function} \hlstd{(}\hlkwc{rows}\hlstd{) \{}
  \hlstd{name} \hlkwb{=} \hlkwd{substr}\hlstd{(rows[}\hlnum{1}\hlstd{,} \hlstr{"name"}\hlstd{],} \hlnum{1}\hlstd{,} \hlkwd{nchar}\hlstd{(rows[}\hlnum{1}\hlstd{,} \hlstr{"name"}\hlstd{])} \hlopt{-} \hlkwd{nchar}\hlstd{(rows[}\hlnum{1}\hlstd{,} \hlstr{"party"}\hlstd{])} \hlopt{-} \hlnum{3}\hlstd{)}
  \hlkwd{data.frame}\hlstd{(}\hlkwc{name} \hlstd{= name,}
             \hlkwc{party} \hlstd{= rows[}\hlnum{1}\hlstd{,} \hlstr{"party"}\hlstd{],}
             \hlkwc{state} \hlstd{= rows[}\hlnum{1}\hlstd{,} \hlstr{"state"}\hlstd{],}
             \hlkwc{before} \hlstd{= rows[}\hlnum{1}\hlstd{,} \hlstr{"coord1D"}\hlstd{],}
             \hlkwc{before.sd} \hlstd{= rows[}\hlnum{1}\hlstd{,} \hlstr{"se1D"}\hlstd{],}
             \hlkwc{after} \hlstd{= rows[}\hlnum{2}\hlstd{,} \hlstr{"coord1D"}\hlstd{],}
             \hlkwc{after.sd} \hlstd{= rows[}\hlnum{2}\hlstd{,} \hlstr{"se1D"}\hlstd{],}
             \hlkwc{diff} \hlstd{=} \hlkwd{diff}\hlstd{(rows[,} \hlstr{"coord1D"}\hlstd{]))}
\hlstd{\})}

\hlkwa{for} \hlstd{(i} \hlkwa{in} \hlnum{1}\hlopt{:}\hlkwd{nrow}\hlstd{(clean_coords)) \{}
  \hlstd{row} \hlkwb{=} \hlstd{clean_coords[i,]}
  \hlstd{same_party_legislators} \hlkwb{=} \hlstd{clean_coords[clean_coords}\hlopt{$}\hlstd{id} \hlopt{!=} \hlstd{row}\hlopt{$}\hlstd{id} \hlopt{&} \hlstd{clean_coords}\hlopt{$}\hlstd{party} \hlopt{==} \hlstd{row}\hlopt{$}\hlstd{party,]}
  \hlstd{clean_coords[i,} \hlstr{"before.party.mean"}\hlstd{]} \hlkwb{=} \hlkwd{mean}\hlstd{(same_party_legislators}\hlopt{$}\hlstd{before,} \hlkwc{na.rm} \hlstd{=} \hlnum{TRUE}\hlstd{)}
  \hlstd{clean_coords[i,} \hlstr{"before.party.median"}\hlstd{]} \hlkwb{=} \hlkwd{median}\hlstd{(same_party_legislators}\hlopt{$}\hlstd{before,} \hlkwc{na.rm} \hlstd{=} \hlnum{TRUE}\hlstd{)}
  \hlstd{clean_coords[i,} \hlstr{"before.party.sd"}\hlstd{]} \hlkwb{=} \hlkwd{sd}\hlstd{(same_party_legislators}\hlopt{$}\hlstd{before,} \hlkwc{na.rm} \hlstd{=} \hlnum{TRUE}\hlstd{)}
  \hlstd{clean_coords[i,} \hlstr{"after.party.mean"}\hlstd{]} \hlkwb{=} \hlkwd{mean}\hlstd{(same_party_legislators}\hlopt{$}\hlstd{after,} \hlkwc{na.rm} \hlstd{=} \hlnum{TRUE}\hlstd{)}
  \hlstd{clean_coords[i,} \hlstr{"after.party.median"}\hlstd{]} \hlkwb{=} \hlkwd{median}\hlstd{(same_party_legislators}\hlopt{$}\hlstd{after,} \hlkwc{na.rm} \hlstd{=} \hlnum{TRUE}\hlstd{)}
  \hlstd{clean_coords[i,} \hlstr{"after.party.sd"}\hlstd{]} \hlkwb{=} \hlkwd{sd}\hlstd{(same_party_legislators}\hlopt{$}\hlstd{after,} \hlkwc{na.rm} \hlstd{=} \hlnum{TRUE}\hlstd{)}
  \hlstd{clean_coords[i,} \hlstr{"diff.party.blah"}\hlstd{]} \hlkwb{=} \hlkwd{median}\hlstd{(same_party_legislators}\hlopt{$}\hlstd{after} \hlopt{-} \hlstd{same_party_legislators}\hlopt{$}\hlstd{before,} \hlkwc{na.rm} \hlstd{= T)}
\hlstd{\}}
\hlstd{clean_coords}\hlopt{$}\hlstd{diff.party.median} \hlkwb{=} \hlstd{clean_coords}\hlopt{$}\hlstd{after.party.median} \hlopt{-} \hlstd{clean_coords}\hlopt{$}\hlstd{before.party.median}
\hlstd{clean_coords}\hlopt{$}\hlstd{diff_legislator_party} \hlkwb{=} \hlstd{clean_coords}\hlopt{$}\hlstd{diff} \hlopt{-} \hlstd{clean_coords}\hlopt{$}\hlstd{diff.party.median}

\hlstd{changed_coalitions_in_period} \hlkwb{=} \hlstd{changed_coalitions[}\hlkwd{between}\hlstd{(changed_coalitions}\hlopt{$}\hlstd{rollcall_date,}
                                                          \hlkwd{as.POSIXct}\hlstd{(}\hlstr{"2011-02-01"}\hlstd{),}
                                                          \hlkwd{as.POSIXct}\hlstd{(}\hlstr{"2015-02-12"}\hlstd{)),]}
\hlstd{clean_coords}\hlopt{$}\hlstd{changed_coalition} \hlkwb{<-} \hlstr{"nao_mudou"}
\hlstd{clean_coords[}\hlkwd{which}\hlstd{(clean_coords}\hlopt{$}\hlstd{id} \hlopt{%in%} \hlstd{changed_coalitions_in_period[changed_coalitions_in_period}\hlopt{$}\hlstd{coalition_after} \hlopt{==} \hlstr{"False"}\hlstd{,]}\hlopt{$}\hlstd{id),]}\hlopt{$}\hlstd{changed_coalition} \hlkwb{<-} \hlstr{"saiu"}
\hlstd{clean_coords[}\hlkwd{which}\hlstd{(clean_coords}\hlopt{$}\hlstd{id} \hlopt{%in%} \hlstd{changed_coalitions_in_period[changed_coalitions_in_period}\hlopt{$}\hlstd{coalition_after} \hlopt{==} \hlstr{"True"}\hlstd{,]}\hlopt{$}\hlstd{id),]}\hlopt{$}\hlstd{changed_coalition} \hlkwb{<-} \hlstr{"entrou"}
\hlstd{clean_coords}\hlopt{$}\hlstd{changed_coalition} \hlkwb{<-} \hlkwd{as.factor}\hlstd{(clean_coords}\hlopt{$}\hlstd{changed_coalition)}

\hlstd{clean_coords}\hlopt{$}\hlstd{name} \hlkwb{<-} \hlkwd{factor}\hlstd{(clean_coords}\hlopt{$}\hlstd{name)}
\hlstd{clean_coords}\hlopt{$}\hlstd{name} \hlkwb{<-} \hlkwd{reorder}\hlstd{(clean_coords}\hlopt{$}\hlstd{name, clean_coords}\hlopt{$}\hlstd{diff)}
\hlstd{clean_coords} \hlkwb{<-} \hlstd{clean_coords[}\hlkwd{order}\hlstd{(}\hlkwd{abs}\hlstd{(clean_coords}\hlopt{$}\hlstd{diff_legislator_party)),]}
\end{alltt}
\end{kframe}
\end{knitrout}



















